type: update
name: multi master
baseUrl: https://raw.githubusercontent.com/donnys27/mysql-cluster-custom/master

skipNodeEmails: false

globals:
  DB_USER: root
  DB_PASSWORD: wQrSbd4yGecJbStM
  ORCHESTRATOR_USER: admin
  ORCHESTRATOR_PASSWORD: 57uHSy4mt9d8
  REPLICA_USER: repl-53252
  REPLICA_PASSWORD: z62WnKjaGY9WHJA

onInstall:
  - setupMultiCluster
  #- setupUser
actions:
  setupMultiCluster:
    - cmd [sqldb]: |-
        /etc/init.d/mysql stop
        /usr/bin/mysqld_safe --skip-grant-tables --skip-networking &
        echo "UPDATE mysql.user SET password = PASSWORD('${globals.DB_PASSWORD}') WHERE User = '${globals.DB_USER}';" | mysql -uroot -p
        /etc/init.d/mysql restart
  setupUser:
    - cmd[sqldb]: |-
        mysql -u${globals.DB_USER} -p${globals.DB_PASSWORD} --execute="CREATE USER IF NOT EXISTS '${globals.REPLICA_USER}'@'%' IDENTIFIED BY '${globals.REPLICA_PASSWORD}';"
        mysql -u${globals.DB_USER} -p${globals.DB_PASSWORD} --execute="GRANT USAGE, SUPER, SELECT, RELOAD, LOCK TABLES, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO '${globals.REPLICA_USER}'@'%';"
        mysql -u${globals.DB_USER} -p${globals.DB_PASSWORD} --execute="FLUSH PRIVILEGES;"